<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆå°±ä¸­å¿ƒ - Arcade Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shop.css') }}">
    <style>
        /* æ–°å¢ç‹€æ…‹é¡è‰²è®Šæ•¸ */
        :root {
            --green: #4ade80;
            --red: #ef4444;
        }
        
        /* é ‚éƒ¨è£å‚™é¡¯ç¤ºå€ */
        .equipped-title-display {
            text-align: center;
            font-size: 1.1em;
            color: var(--text-muted);
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .equipped-title-name {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--gold);
            margin: 0;
            white-space: nowrap;
        }
        
        /* ç¨±è™Ÿå¡ç‰‡ä½ˆå±€èª¿æ•´ */
        .achievement-card {
            min-height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px !important;
        }
        
        /* ç¨±è™Ÿæè¿° */
        .card-description {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            margin: 10px 0;
            font-size: 0.95rem;
        }
        
        /* ç‹€æ…‹æ–‡å­— */
        .card-status {
            font-weight: bold;
            margin-top: auto;
            margin-bottom: 15px;
            font-size: 1rem;
        }
    </style>
</head>
<body>

    <div class="user-menu">
        <div class="user-profile-btn" style="cursor: default;"> 
            <div class="avatar-display">
                {% if user.avatar == 'default.png' %}
                    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=0f172a&color=fff" alt="User Avatar">
                {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + user.avatar) }}" alt="User Avatar">
                {% endif %}
            </div>
            <span class="username-display">{{ user.username }}</span>
        </div>
    </div>

    <div class="shop-container">
        <h1>ğŸ† æˆå°±èˆ‡ç¨±è™Ÿä¸­å¿ƒ</h1>
        <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 1.1em;">
            è§£é–ç¨±è™Ÿï¼Œè®“ä½ çš„åå­—é–ƒè€€å…‰èŠ’ï¼
        </p>

        <div class="equipped-title-display">
            ç›®å‰è£å‚™: 
            <span id="equippedTitle" class="equipped-title-name">
                {{ equipped_title_display if equipped_title_display else 'æœªè£å‚™' }}
            </span>
            <button class="btn-secondary" onclick="equipTitle('')" 
                    {% if not equipped_title_display or equipped_title_display == 'æœªè£å‚™' %}disabled{% endif %}>
                å¸ä¸‹
            </button>
        </div>

        <div class="recharge-grid">
            {% for title in titles %}
            <div class="recharge-card achievement-card" data-title-id="{{ title.id }}">
                <p class="card-price">{{ title.display_name }}</p>
                
                <p class="card-description">{{ title.description }}</p>
                
                <p class="card-status" id="status-{{ title.id }}">
                    {% if title.equipped %}
                        <span style="color: var(--gold);">ğŸ… å·²è£å‚™</span>
                    {% elif title.unlocked %}
                        <span style="color: var(--green);">ğŸ”“ å·²è§£é–</span>
                    {% else %}
                        <span style="color: var(--red);">
                            ğŸ”’ æœªè§£é– 
                            {% if title.game_name != 'any' %}
                                (éœ€ {{ title.game_name }} {{ title.required_score }})
                            {% endif %}
                        </span>
                    {% endif %}
                </p>
                
                <button 
                    id="btn-{{ title.id }}"
                    class="btn-primary" 
                    onclick="equipTitle('{{ title.id }}', '{{ title.display_name }}')"
                    {% if not title.unlocked or title.equipped %}disabled{% endif %}
                >
                    {% if title.equipped %}
                        å·²è£å‚™
                    {% else %}
                        è£å‚™æ­¤ç¨±è™Ÿ
                    {% endif %}
                </button>
            </div>
            {% endfor %}
        </div>

        <a href="/lobby" class="btn-secondary" style="margin-top: 50px; border-radius: 50px; padding: 10px 30px; text-decoration: none; display: inline-block;">
            â† è¿”å›å¤§å»³
        </a>
    </div>

    <script>
        // è™•ç†è£å‚™/å¸ä¸‹ç¨±è™Ÿçš„éåŒæ­¥è«‹æ±‚
        function equipTitle(titleId, displayName) {
            // è©¢å•ä½¿ç”¨è€…
            if (!titleId) {
                if (!confirm(`ç¢ºå®šè¦å¸ä¸‹ç›®å‰çš„ç¨±è™Ÿå—ï¼Ÿ`)) return;
            } else if (!confirm(`ç¢ºå®šè¦è£å‚™ç¨±è™Ÿã€Œ${displayName}ã€å—ï¼Ÿ`)) {
                return;
            }

            fetch("{{ url_for('api_equip_title') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title_id: titleId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 1. æ›´æ–°é ‚éƒ¨é¡¯ç¤ºèˆ‡å¸ä¸‹æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('equippedTitle').innerText = data.new_title;
                    const unequipBtn = document.querySelector('.equipped-title-display .btn-secondary');
                    unequipBtn.disabled = (data.new_title === 'æœªè£å‚™');

                    // 2. æ›´æ–°æ‰€æœ‰æŒ‰éˆ•å’Œç‹€æ…‹æ¨™ç±¤
                    document.querySelectorAll('.achievement-card').forEach(card => {
                        const id = card.getAttribute('data-title-id');
                        const statusSpan = document.getElementById(`status-${id}`);
                        const button = document.getElementById(`btn-${id}`);
                        
                        // æª¢æŸ¥å¡ç‰‡æ˜¯å¦å·²è§£é– (ç°¡å–®çš„åˆ¤æ–·ï¼Œç¢ºä¿ä¸æ˜¯æœªè§£é–çš„ğŸ”’)
                        const isUnlocked = !statusSpan.innerHTML.includes('ğŸ”’');

                        if (id === titleId && titleId !== '') {
                            // è¨­ç½®æ–°è£å‚™çš„ç¨±è™Ÿ
                            statusSpan.innerHTML = 'ğŸ… å·²è£å‚™';
                            statusSpan.style.color = 'var(--gold)';
                            button.innerText = 'å·²è£å‚™';
                            button.disabled = true;
                        } else if (isUnlocked) {
                            // æ¢å¾©ä¹‹å‰è£å‚™çš„æˆ–åªæ˜¯å·²è§£é–çš„ç¨±è™Ÿ
                            statusSpan.innerHTML = 'ğŸ”“ å·²è§£é–';
                            statusSpan.style.color = 'var(--green)';
                            button.innerText = 'è£å‚™æ­¤ç¨±è™Ÿ';
                            button.disabled = false;
                        } else {
                            // ä¿æŒé–å®šç‹€æ…‹
                            button.disabled = true;
                            button.innerText = 'è£å‚™æ­¤ç¨±è™Ÿ';
                        }
                    });

                    alert(data.message);
                    
                } else {
                    alert('æ“ä½œå¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });
        }
    </script>
</body>
</html>